name: Build and Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
#    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    env:
      BUILD_ID: build-${{ github.run_id }}-${{ github.run_attempt }}
      DIST_PATH: /

    steps:
      - name: Dump github
        run: echo "${{ github }}"

      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3

      - id: 'package_json'
        run: echo contents=$(cat package.json) >> $GITHUB_OUTPUT

      - name: Update dist path with version
        run: echo DIST_PATH=/v/${{ fromJson(steps.package_json.outputs.contents).version }} >> $GITHUB_ENV

#      - name: Print id
#        run: echo ${{ env.BUILD_ID }}

      - name: Install and Build ðŸ”§ # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          npm ci
          npm run build

      - name: Custom git fetch
        run: |
          git init 
          git config user.name "Jan Kaczan"
          git config user.email "jan@kaczan.eu"
          git remote remove origin
          git remote add git@github.com:jhajduk-pgs/ghpages.git
          git fetch
          git worktree add --checkout ghp-temp origin/gh-pages
          ls -a

      - name: Update main docs
        run: |
          rsync -q -av --checksum --progress dist ghp-temp --delete --exclude v --exclude CNAME --exclude .nojekyll --exclude .ssh --exclude .git --exclude .github
          cp dist ghp-temp/${{ env.DIST_PATH }}
          ls -a
          cd ghp-temp
          ls -a
          cd v
          ls -a
          

      - name: Update preview
        run: |
          echo siema
          
          

#      - name: Deploy ðŸš€
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          folder: dist # The folder the action should deploy.
#          target-folder: ${{ env.DIST_PATH }}
#          clean: true # Automatically remove deleted files from the deploy branch
#          clean-exclude: '["v"]'
#
#      - name: Deploy ðŸš€
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          folder: dist # The folder the action should deploy.
#          target-folder: /
#          clean: true # Automatically remove deleted files from the deploy branch
#          clean-exclude: '["v"]'


