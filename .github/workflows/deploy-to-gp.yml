name: Deploy docs
on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      PACKAGE_JSON: contents=$(cat package.json) >> $GITHUB_OUTPUT
      DIST_PATH: /v/${{ fromJson(steps.package_json.outputs.contents).version }}
      BUILD_PATH: dist
      GHP_TEMP_PATH: ghp-temp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install and build docs
        run: |
          npm ci
          npm run build:docs

      - name: Deploy
        uses: ./.github/actions/pages-deploy
        with:
          temp-dir: ${{ env.GHP_TEMP_PATH }}
          commands: |
            rsync -q -av --checksum --progress ${{ env.BUILD_PATH }}/ ${{ env.GHP_TEMP_PATH }} --delete --exclude v --exclude preview --exclude CNAME --exclude .nojekyll --exclude .ssh --exclude .git --exclude .github
            cp -r ${{ env.BUILD_PATH }}/. ${{ env.GHP_TEMP_PATH }}/${{ env.DIST_PATH }}
