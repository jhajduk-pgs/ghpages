name: Build and Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
#    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    env:
      BUILD_ID: ${{ github.run_id }}-${{ github.run_attempt }}
      DIST_PATH: /
      REPOSITORY_PATH: https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
      DEPLOY_BRANCH: gh-pages-deploy/${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - name: Dump github
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"


      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - id: 'package_json'
        run: echo contents=$(cat package.json) >> $GITHUB_OUTPUT

      - name: Update dist path with version
        run: echo DIST_PATH=/v/${{ fromJson(steps.package_json.outputs.contents).version }} >> $GITHUB_ENV

#      - name: Print id
#        run: echo ${{ env.BUILD_ID }}

      - name: Install and Build 🔧 # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          npm ci
          npm run build

      - name: Custom git fetch
        run: |
          git init 
          git config user.name "Jan Kaczan"
          git config user.email "jan@kaczan.eu"
          git remote rm origin
          git remote add origin ${{ env.REPOSITORY_PATH }}
          git fetch
          git worktree add --checkout ghp-temp origin/gh-pages
          ls -a

      - name: Update main docs
        run: |
          rsync -q -av --checksum --progress dist/ ghp-temp --delete --exclude v --exclude CNAME --exclude .nojekyll --exclude .ssh --exclude .git --exclude .github
          cp -r dist/. ghp-temp/${{ env.DIST_PATH }}
          tree

      - name: Update preview
        run: |
          echo siema

      - name: Push to gh-pages
        run: |
          tree
          cd ghp-temp
          tree
          git status --porcelain
          
          git add --all .
          git checkout -b ${{ env.DEPLOY_BRANCH }}
          git commit -m "Deploying @${{ github.sha }}" --quiet --no-verify
          git push --force ${{ env.REPOSITORY_PATH }} ${{ env.DEPLOY_BRANCH }}:gh-pages
          cd ..
          git worktree remove ghp-temp --force



#      - name: Deploy 🚀
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          folder: dist # The folder the action should deploy.
#          target-folder: ${{ env.DIST_PATH }}
#          clean: true # Automatically remove deleted files from the deploy branch
#          clean-exclude: '["v"]'
#
#      - name: Deploy 🚀
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          folder: dist # The folder the action should deploy.
#          target-folder: /
#          clean: true # Automatically remove deleted files from the deploy branch
#          clean-exclude: '["v"]'


